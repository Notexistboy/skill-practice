<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <script>
        // 题目需求
        let middlewares = []
        middlewares.push((ctx,next) => {
            console.log(1)
            next()
            console.log(1.1)
        })
        middlewares.push((ctx,next) => {
            console.log(2)
            next()
            console.log(2.1)
        })
        middlewares.push((ctx,next) => {
            console.log(3)
            next()
            console.log(3.1)
        })

        let fn = compose(middlewares)
        fn(this);


        /*
        1
        2
        3
        3.1
        2.1
        1.1
        */

        //实现compose函数
        /**
         * Compose `middleware` returning
         * a fully valid middleware comprised
         * of all those which are passed.
         *
         * @param {Array} middleware
         * @return {Function}
         * @api public
         */
        function compose(middlewares) {
            return function(context, next) {
                let index = -1
                dispatch(0);
                function dispatch(i) {
                    if(i <= index) Promise.reject('error')
                    index = i;
                    let fn = middlewares[i]

                    if(i === middlewares.length) fn = next;
                    if(!fn) return Promise.resolve()
                    try {
                        Promise.resolve(fn(context, dispatch.bind(null, i+1)))
                    } catch (e) {
                        Promise.reject(e)
                    }

                }
            }
        };

        </script>
</body>

</html>